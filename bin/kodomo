#!/usr/bin/env php
<?php

// Check if running as global composer package or local
if (file_exists(__DIR__ . '/../../autoload.php')) {
    // Global installation
    require __DIR__ . '/../../autoload.php';
} elseif (file_exists(__DIR__ . '/../vendor/autoload.php')) {
    // Local installation
    require __DIR__ . '/../vendor/autoload.php';
} else {
    echo "‚ùå Composer autoload not found. Please run 'composer install' first.\n";
    exit(1);
}

use Kodomo\Installer;

$command = $argv[1] ?? null;
$arg = $argv[2] ?? null;
$arg2 = $argv[3] ?? null;

// Validate project name format
function isValidProjectName($name) {
    return preg_match('/^[a-z0-9_\-]+$/i', $name) && strlen($name) <= 50;
}

switch ($command) {
    case 'new':
        if (!$arg) {
            echo "Usage: kodomo new <project-name>\n";
            echo "Example: kodomo new my-app\n";
            exit(1);
        }
        
        if (!isValidProjectName($arg)) {
            echo "‚ùå Invalid project name. Use only letters, numbers, hyphens, and underscores.\n";
            exit(1);
        }
        
        try {
            $projectPath = Installer::createProject($arg);
            
            echo "üéâ Kodomo project '$arg' created successfully!\n\n";
            echo "üìÅ Location: $projectPath\n\n";
            echo "üöÄ Next steps:\n";
            echo "   cd $arg\n";
            echo "   composer install\n";
            echo "   php -S localhost:8000 -t public\n\n";
            echo "üìö Documentation: https://github.com/kodomo/framework\n";
            
        } catch (Exception $e) {
            echo "‚ùå Error: " . $e->getMessage() . "\n";
            exit(1);
        }
        break;

    case 'make:controller':
        if (!$arg) {
            echo "Usage: kodomo make:controller ControllerName\n";
            exit(1);
        }
        makeController($arg);
        break;

    case 'make:model':
        if (!$arg) {
            echo "Usage: kodomo make:model ModelName\n";
            exit(1);
        }
        makeModel($arg);
        break;

    case 'make:view':
        if (!$arg) {
            echo "Usage: kodomo make:view viewName\n";
            exit(1);
        }
        makeView($arg);
        break;

    case 'cache:clear':
        clearCache();
        break;

    case 'list:routes':
        listRoutes();
        break;

    case 'serve':
        $port = $arg ?? '8000';
        echo "üöÄ Starting Kodomo development server on http://localhost:$port\n";
        echo "üìÅ Serving from: " . getcwd() . "/public\n";
        echo "‚èπÔ∏è  Press Ctrl+C to stop\n";
        passthru("php -S localhost:$port -t public");
        break;

    case '--version':
    case '-v':
        echo "üéå Kodomo Framework v" . Installer::getVersion() . "\n";
        break;

    case 'hello':
        echo "üëã Hello from Kodomo Framework CLI!\n";
        break;

    default:
        showHelp();
}

function showHelp()
{
    echo "üéå Kodomo Framework CLI\n";
    echo "======================\n\n";
    echo "Available commands:\n";
    echo "  new <project-name>         Create a new Kodomo project\n";
    echo "  make:controller <name>     Create a new controller\n";
    echo "  make:model <name>          Create a new model\n";
    echo "  make:view <name>           Create a new view\n";
    echo "  cache:clear                Clear framework cache\n";
    echo "  list:routes                List all registered routes\n";
    echo "  serve [port]               Start development server (default: 8000)\n";
    echo "  --version, -v              Show version information\n";
    echo "  hello                      Test command\n\n";
    echo "Examples:\n";
    echo "  kodomo new blog\n";
    echo "  kodomo make:controller UserController\n";
    echo "  kodomo serve 8080\n\n";
    echo "Documentation: https://github.com/kodomo/framework\n";
}

// Generator functions for the main CLI
function makeController($name)
{
    $base = getcwd();
    $controllerFile = "$base/src/Controllers/{$name}.php";
    
    if (file_exists($controllerFile)) {
        echo "‚ùå Controller '$name' already exists!\n";
        return;
    }

    // Ensure directory exists
    if (!is_dir(dirname($controllerFile))) {
        mkdir(dirname($controllerFile), 0755, true);
    }

    $content = "<?php

namespace App\Controllers;

class {$name}
{
    public function index()
    {
        return view('" . strtolower($name) . ".index');
    }
    
    public function create()
    {
        return view('" . strtolower($name) . ".create');
    }
    
    public function store(\\Kodomo\\Core\\Request \$request)
    {
        // Handle form submission
        return redirect('/" . strtolower($name) . "');
    }
    
    public function show(\$id)
    {
        return \"Showing {$name} with ID: \" . \$id;
    }
    
    public function edit(\$id)
    {
        return view('" . strtolower($name) . ".edit', ['id' => \$id]);
    }
    
    public function update(\\Kodomo\\Core\\Request \$request, \$id)
    {
        // Handle update
        return redirect('/" . strtolower($name) . "/' . \$id);
    }
    
    public function destroy(\$id)
    {
        // Handle deletion
        return redirect('/" . strtolower($name) . "');
    }
}";

    file_put_contents($controllerFile, $content);
    echo "‚úÖ Controller created: src/Controllers/{$name}.php\n";
}

function makeModel($name)
{
    $base = getcwd();
    $modelFile = "$base/src/Models/{$name}.php";
    
    if (file_exists($modelFile)) {
        echo "‚ùå Model '$name' already exists!\n";
        return;
    }

    // Ensure directory exists
    if (!is_dir(dirname($modelFile))) {
        mkdir(dirname($modelFile), 0755, true);
    }

    $content = "<?php

namespace App\Models;

use Kodomo\\Models\\Model;

class {$name} extends Model
{
    protected static \$table = '" . strtolower($name) . "s';
    
    // Add your model methods here
    public function specialMethod()
    {
        return \"Special method from {$name} model\";
    }
}";

    file_put_contents($modelFile, $content);
    echo "‚úÖ Model created: src/Models/{$name}.php\n";
}

function makeView($name)
{
    $base = getcwd();
    $viewFile = "$base/src/Views/{$name}.php";
    
    if (file_exists($viewFile)) {
        echo "‚ùå View '$name' already exists!\n";
        return;
    }

    // Ensure directory exists
    if (!is_dir(dirname($viewFile))) {
        mkdir(dirname($viewFile), 0755, true);
    }

    $content = '<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>' . ucfirst($name) . ' - Kodomo Framework</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">üéå Kodomo Framework</a>
        </div>
    </nav>

    <div class="container mt-4">
        <h1>' . ucfirst(str_replace('.', ' - ', $name)) . '</h1>
        <p>This view was generated with Kodomo Framework CLI.</p>
        
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Welcome to your new view!</h5>
                <p class="card-text">Start building your amazing application here.</p>
                <a href="/" class="btn btn-primary">Go Home</a>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>';

    file_put_contents($viewFile, $content);
    echo "‚úÖ View created: src/Views/{$name}.php\n";
}

function clearCache()
{
    $base = getcwd();
    $cacheDir = "$base/cache";
    
    if (is_dir($cacheDir)) {
        array_map('unlink', glob("$cacheDir/*"));
        echo "‚úÖ Cache cleared!\n";
    } else {
        echo "‚ÑπÔ∏è  No cache directory found.\n";
    }
    
    if (function_exists('opcache_reset')) {
        opcache_reset();
        echo "‚úÖ OPcache cleared!\n";
    }
}

function listRoutes()
{
    $base = getcwd();
    $webRoutesFile = "$base/routes/web.php";
    $apiRoutesFile = "$base/routes/api.php";
    
    echo "üìç Registered Routes:\n";
    echo "====================\n";
    
    if (file_exists($webRoutesFile)) {
        echo "üåê Web Routes:\n";
        $content = file_get_contents($webRoutesFile);
        preg_match_all('/\\$router->(get|post|put|delete)\\(\\s*\\\'([^\\\']+)\\\'\\s*,\\s*\\[([^]]+)\\]/', $content, $matches);
        
        if (empty($matches[0])) {
            echo "  No web routes found.\n";
        } else {
            foreach ($matches[1] as $index => $method) {
                $path = $matches[2][$index];
                $handler = $matches[3][$index];
                echo "  " . str_pad(strtoupper($method), 6) . " $path ‚Üí $handler\n";
            }
        }
    } else {
        echo "üåê Web Routes: routes/web.php not found\n";
    }
    
    if (file_exists($apiRoutesFile)) {
        echo "\nüîó API Routes:\n";
        $content = file_get_contents($apiRoutesFile);
        preg_match_all('/\\$router->(get|post|put|delete)\\(\\s*\\\'([^\\\']+)\\\'\\s*,\\s*\\[([^]]+)\\]/', $content, $matches);
        
        if (empty($matches[0])) {
            echo "  No API routes found.\n";
        } else {
            foreach ($matches[1] as $index => $method) {
                $path = $matches[2][$index];
                $handler = $matches[3][$index];
                echo "  " . str_pad(strtoupper($method), 6) . " $path ‚Üí $handler\n";
            }
        }
    } else {
        echo "\nüîó API Routes: routes/api.php not found\n";
    }
}