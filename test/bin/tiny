#!/usr/bin/env php
<?php
require __DIR__ . '/../vendor/autoload.php';

$command = $argv[1] ?? null;
$arg = $argv[2] ?? null;

switch ($command) {
    case 'make:controller':
        if (!$arg) {
            echo "Usage: php bin/tiny make:controller ControllerName\n";
            exit;
        }
        $base = getcwd();
        $controllerFile = "$base/src/Controllers/{$arg}.php";
        
        if (file_exists($controllerFile)) {
            echo "Controller '$arg' already exists!\n";
            exit;
        }

        $content = "<?php

namespace Tiny\Controllers;

class {$arg}
{
    public function index()
    {
        return \"Hello from {$arg}::index()\";
    }
}";

        file_put_contents($controllerFile, $content);
        echo "Controller created: src/Controllers/{$arg}.php\n";
        break;

    case 'make:model':
        if (!$arg) {
            echo "Usage: php bin/tiny make:model ModelName\n";
            exit;
        }
        $base = getcwd();
        $modelFile = "$base/src/Models/{$arg}.php";
        
        if (file_exists($modelFile)) {
            echo "Model '$arg' already exists!\n";
            exit;
        }

        $content = "<?php

namespace Tiny\Models;

class {$arg} extends Model
{
    protected static \$table = '" . strtolower($arg) . "s';
}";

        file_put_contents($modelFile, $content);
        echo "Model created: src/Models/{$arg}.php\n";
        break;

    case 'make:view':
        if (!$arg) {
            echo "Usage: php bin/tiny make:view viewName\n";
            exit;
        }
        $base = getcwd();
        $viewFile = "$base/src/Views/{$arg}.php";
        
        if (file_exists($viewFile)) {
            echo "View '$arg' already exists!\n";
            exit;
        }

        $content = '<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>' . $arg . '</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">Tiny Framework</a>
        </div>
    </nav>

    <div class="container mt-4">
        <h1>Welcome to ' . $arg . ' View</h1>
        <p>This view includes Bootstrap styling.</p>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>';

        file_put_contents($viewFile, $content);
        echo "View created: src/Views/{$arg}.php (with Bootstrap)\n";
        break;

    case 'cache:clear':
        $base = getcwd();
        $cacheDir = "$base/cache";
        
        if (is_dir($cacheDir)) {
            array_map('unlink', glob("$cacheDir/*"));
            echo "Cache cleared!\n";
        } else {
            echo "No cache directory found.\n";
        }
        
        if (function_exists('opcache_reset')) {
            opcache_reset();
            echo "OPcache cleared!\n";
        }
        break;

    case 'list:routes':
        $base = getcwd();
        $indexFile = "$base/public/index.php";
        
        if (!file_exists($indexFile)) {
            echo "No routes file found.\n";
            exit;
        }
        
        echo "Registered Routes:\n";
        echo "==================\n";
        
        $content = file_get_contents($indexFile);
        preg_match_all('/\$app->router->(get|post|put|delete)\s*\(\s*\'([^\']+)\'\s*,\s*\[([^]]+)\]/', $content, $matches);
        
        if (empty($matches[0])) {
            echo "No routes found.\n";
            exit;
        }
        
        foreach ($matches[1] as $index => $method) {
            $path = $matches[2][$index];
            $handler = $matches[3][$index];
            echo str_pad(strtoupper($method), 6) . " $path -> $handler\n";
        }
        break;

    default:
        echo "Tiny Framework CLI\n";
        echo "Available commands:\n";
        echo "  make:controller <name>\n";
        echo "  make:model <name>\n";
        echo "  make:view <name>\n";
        echo "  cache:clear\n";
        echo "  list:routes\n";
}